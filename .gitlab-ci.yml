before_script:
  - SCRATCH_DIR=$(readlink -f "../scratch-space") # get absolute path
  - NiftyMatch_SOURCE_DIR="$(pwd)/src"
  - NiftyMatch_BUILD_DIR="$SCRATCH_DIR/build/NiftyMatch"
  - INSTALL_DIR="$SCRATCH_DIR/install"
  - NiftyMatch_DIR="$INSTALL_DIR/include/nm"
  - cuSIFT_REPO_DIR="$SCRATCH_DIR/source/cuSIFT"
  - cuSIFT_SOURCE_DIR="$cuSIFT_REPO_DIR/src"
  - cuSIFT_BUILD_DIR="$SCRATCH_DIR/build/cuSIFT"

stages:
  - build
  - deploy # faking deploy for now, i.e. only for testing
  - test

build-linux:
  stage: build
  script:
    - rm -rf "$NiftyMatch_BUILD_DIR"
    - mkdir -p "$NiftyMatch_BUILD_DIR"
    - cd "$NiftyMatch_BUILD_DIR"
    - cmake -D CMAKE_INSTALL_PREFIX="$INSTALL_DIR" "$NiftyMatch_SOURCE_DIR"
    - make -j
  tags:
    - gift-linux
    - cuda

deploy-linux:
  stage: deploy
  script:
    - cd "$NiftyMatch_BUILD_DIR"
    - make install
    - rm -rf "$cuSIFT_REPO_DIR"
    - git clone git@cmiclab.cs.ucl.ac.uk:GIFT-Surg/cuSIFT.git "$cuSIFT_REPO_DIR" --branch dev
    - rm -rf "$cuSIFT_BUILD_DIR"
    - mkdir -p "$cuSIFT_BUILD_DIR"
    - cd "$cuSIFT_BUILD_DIR"
    - cmake -D NiftyMatch_DIR="$NiftyMatch_DIR" -D BUILD_TESTS=ON "$cuSIFT_SOURCE_DIR"
    - make -j
  tags:
    - gift-linux
    - cuda

test-linux:
  stage: test
  script:
    - cd "$cuSIFT_BUILD_DIR"
    - make test
    # TODO: to be enabled later    
    # - cat ./Testing/Temporary/LastTest.log | grep -B 15 -A 5 -n -i "failed"
  tags:
    - gift-linux
    - cuda